# CI/CD Pipeline

Este proyecto utiliza **GitHub Actions** para automatizar testing, linting, builds y deployments.

## ğŸ“‹ Workflows Configurados

### 1. CI Workflow (`ci.yml`)

Se ejecuta en **push** y **pull requests** a `main` y `develop`.

#### Jobs:

**Lint:**
- âœ… ESLint
- âœ… Prettier format check
- â±ï¸ ~30 segundos

**Test:**
- âœ… Ejecuta todos los tests
- âœ… Genera reporte de cobertura
- âœ… Sube cobertura a Codecov
- â±ï¸ ~45 segundos

**Build:**
- âœ… Build para development, staging y production
- âœ… Sube artefactos (7 dÃ­as de retenciÃ³n)
- â±ï¸ ~1-2 minutos por ambiente

### 2. Deploy Workflow (`deploy.yml`)

Deployments automÃ¡ticos basados en branches y tags.

#### Environments:

**Development:**
- ğŸ”€ Branch: `develop`
- ğŸŒ URL: `https://dev.voiceauth.example.com`
- ğŸš€ Deploy automÃ¡tico

**Staging:**
- ğŸ”€ Branch: `main`
- ğŸŒ URL: `https://staging.voiceauth.example.com`
- ğŸš€ Deploy automÃ¡tico

**Production:**
- ğŸ·ï¸ Tags: `v*` (ej: v1.0.0)
- ğŸŒ URL: `https://voiceauth.example.com`
- âœ… Requiere tests pasando
- ğŸ“¦ Crea GitHub Release

### 3. PR Checks Workflow (`pr-checks.yml`)

Se ejecuta en **pull requests**.

#### Jobs:

**PR Info:**
- ğŸ“ Muestra informaciÃ³n del PR
- ğŸ‘¤ Autor
- ğŸ”€ Branches

**Validate:**
- âœ… Lint
- âœ… Format check
- âœ… Tests con cobertura
- âœ… Build
- âœ… Bundle size check

**Security:**
- ğŸ”’ npm audit
- âš ï¸ Detecta vulnerabilidades

**Size Check:**
- ğŸ“¦ Calcula tamaÃ±o del bundle
- ğŸ’¬ Comenta en PR con resultados

## ğŸš€ Uso

### Desarrollo Normal

```bash
# Crear feature branch
git checkout -b feature/nueva-feature

# Hacer cambios y commit
git add .
git commit -m "feat: nueva feature"

# Push trigger CI
git push origin feature/nueva-feature
```

**GitHub Actions ejecutarÃ¡:**
- âœ… Lint
- âœ… Tests
- âœ… Build

### Crear Pull Request

Al crear PR, se ejecutan **todos los checks**:

```bash
gh pr create --base develop --title "Nueva feature"
```

**Checks que se ejecutan:**
- âœ… CI workflow (lint, test, build)
- âœ… PR checks (validaciÃ³n, seguridad, tamaÃ±o)
- ğŸ’¬ Comentarios automÃ¡ticos con info del build

### Deploy a Development

```bash
# Merge a develop
git checkout develop
git merge feature/nueva-feature
git push origin develop
```

**Resultado:** Deploy automÃ¡tico a `dev.voiceauth.example.com`

### Deploy a Staging

```bash
# Merge a main
git checkout main
git merge develop
git push origin main
```

**Resultado:** Deploy automÃ¡tico a `staging.voiceauth.example.com`

### Deploy a Production

```bash
# Crear tag
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0
```

**Resultado:**
- Tests ejecutados
- Build de producciÃ³n
- Deploy a `voiceauth.example.com`
- GitHub Release creado

## âš™ï¸ ConfiguraciÃ³n

### Secrets Requeridos

Configurar en **GitHub â†’ Settings â†’ Secrets and variables â†’ Actions**:

```bash
# Development
DEV_API_URL=https://api-dev.example.com

# Staging
STAGING_API_URL=https://api-staging.example.com

# Production
PROD_API_URL=https://api.example.com

# GitHub Token (ya existe por defecto)
GITHUB_TOKEN=<auto-generated>

# Codecov (opcional)
CODECOV_TOKEN=<your-token>
```

### Environments

Configurar en **GitHub â†’ Settings â†’ Environments**:

1. **development**
   - No requiere aprobaciÃ³n
   - Branch: `develop`

2. **staging**
   - No requiere aprobaciÃ³n
   - Branch: `main`

3. **production**
   - âš ï¸ Requiere aprobaciÃ³n manual
   - Tags: `v*`
   - Protection rules activas

## ğŸ“Š Status Badges

Agregar a tu README.md:

```markdown
![CI](https://github.com/tomipoch/Proyecto/workflows/CI/badge.svg)
![Tests](https://github.com/tomipoch/Proyecto/workflows/CI/badge.svg?event=push)
![Coverage](https://codecov.io/gh/tomipoch/Proyecto/branch/main/graph/badge.svg)
```

## ğŸ”§ PersonalizaciÃ³n

### Modificar Node.js version

En cada workflow:

```yaml
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '20'  # Cambiar aquÃ­
    cache: 'npm'
```

### Agregar mÃ¡s environments

Crear nuevo archivo `.github/workflows/deploy-custom.yml`:

```yaml
name: Custom Deploy

on:
  push:
    branches: [custom-branch]

jobs:
  deploy-custom:
    runs-on: ubuntu-latest
    environment:
      name: custom
      url: https://custom.example.com
    
    steps:
      # ... pasos de deploy
```

### Notificaciones (Slack, Discord, etc.)

Agregar al final de cada job:

```yaml
- name: Notify Slack
  if: always()
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

### Ejecutar en horarios especÃ­ficos

```yaml
on:
  schedule:
    - cron: '0 0 * * *'  # Diario a medianoche
```

## ğŸ› Troubleshooting

### Error: "npm ci failed"

**Causa:** package-lock.json desactualizado

**SoluciÃ³n:**
```bash
npm install
git add package-lock.json
git commit -m "chore: update package-lock"
```

### Error: "Tests failed"

**Causa:** Tests no pasan en CI

**SoluciÃ³n:**
```bash
# Ejecutar localmente
npm test

# Corregir y commit
git add .
git commit -m "fix: failing tests"
```

### Error: "Build failed"

**Causa:** Variables de entorno faltantes

**SoluciÃ³n:** Verificar secrets en GitHub Settings

### Workflow no se ejecuta

**Causas posibles:**
1. Archivo YAML con errores de sintaxis
2. Workflow deshabilitado
3. Branch no incluido en `on: push:`

**SoluciÃ³n:**
```bash
# Validar YAML
yamllint .github/workflows/ci.yml

# Verificar en GitHub Actions tab
```

### Deploy no funciona

**Verificar:**
1. âœ… Secrets configurados
2. âœ… Environment creado
3. âœ… Permisos de Actions habilitados
4. âœ… Branch/tag correcto

## ğŸ“ˆ Mejoras Futuras

### 1. Parallel Testing
```yaml
test:
  strategy:
    matrix:
      node-version: [18, 20]
  steps:
    # ... tests
```

### 2. Cache de Dependencies
```yaml
- name: Cache node modules
  uses: actions/cache@v3
  with:
    path: node_modules
    key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
```

### 3. Lighthouse CI
```yaml
- name: Run Lighthouse
  uses: treosh/lighthouse-ci-action@v10
  with:
    urls: |
      https://staging.voiceauth.example.com
```

### 4. E2E Tests (Playwright)
```yaml
- name: E2E Tests
  run: npx playwright test
```

### 5. Dependabot
Crear `.github/dependabot.yml`:

```yaml
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
```

## ğŸ“ Best Practices

### âœ… DO

- Usar `npm ci` en CI (no `npm install`)
- Cachear dependencias
- Ejecutar tests en paralelo
- Limitar retenciÃ³n de artefactos
- Configurar timeouts
- Usar secrets para datos sensibles

### âŒ DON'T

- No usar `npm install` (inconsistente)
- No hardcodear secrets en workflows
- No ejecutar builds innecesarios
- No ignorrar warnings de seguridad
- No deployar sin tests

## ğŸ”— Recursos

- [GitHub Actions Docs](https://docs.github.com/en/actions)
- [Workflow Syntax](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions)
- [Actions Marketplace](https://github.com/marketplace?type=actions)
- [Codecov](https://codecov.io/)

## ğŸ“ Monitoreo

### Ver Logs

```bash
# GitHub CLI
gh run list
gh run view <run-id>
gh run watch
```

### Status de Workflows

GitHub â†’ Actions tab â†’ Ver todos los workflows

### MÃ©tricas

- â±ï¸ Tiempo promedio de CI: ~2-3 minutos
- âœ… Success rate objetivo: >95%
- ğŸ“¦ Deployments/dÃ­a: Variable segÃºn actividad

---

**Pipeline configurado con â¤ï¸ para deployments confiables**
